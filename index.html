<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Joyeux Anniversaire Papa üéâ - Chasse au Tr√©sor ULTIME</title>
    <!-- Chargement de Tailwind CSS pour un style rapide et r√©actif -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chargement des librairies pour les fonctionnalit√©s avanc√©es -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://unpkg.com/tone@14.8.49/build/Tone.js"></script>
    <style>
        /* Configuration de la police Inter pour tout le document */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            overflow-x: hidden;
            background-color: #0d0a1b; /* Couleur de fond sombre */
        }
        /* Style g√©n√©ral de l'arri√®re-plan anim√© */
        .animated-background {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -10;
            background: linear-gradient(-45deg, #1d0033, #5a184a, #0d0a1b, #03102a);
            background-size: 400% 400%;
            animation: gradient-animation 15s ease infinite;
            filter: brightness(0.9) contrast(1.1);
            transition: background-color 0.05s ease-in-out; /* Pour l'effet de disjonction */
        }
        @keyframes gradient-animation {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        
        /* Style pour les cartes principales (effet de lueur) */
        .card {
            background-color: rgba(20, 15, 40, 0.95);
            backdrop-filter: blur(10px);
            box-shadow: 0 0 15px rgba(255, 65, 108, 0.3), 0 10px 30px rgba(0, 0, 0, 0.7);
            border: 1px solid rgba(255, 65, 108, 0.2);
            transition: all 0.5s ease-in-out;
        }
        /* Style pour les boutons interactifs */
        .btn-primary {
            background: linear-gradient(135deg, #ff416c, #ff4b2b);
            box-shadow: 0 4px 20px rgba(255, 75, 43, 0.6);
            transition: transform 0.1s, box-shadow 0.3s;
        }
        .btn-primary:hover {
            transform: translateY(-3px) scale(1.02);
            box-shadow: 0 8px 30px rgba(255, 75, 43, 0.8);
        }
        .btn-primary:active {
            transform: translateY(0);
            box-shadow: 0 2px 10px rgba(255, 75, 43, 0.4);
        }

        /* Animations personnalis√©es */
        @keyframes fade-in-up {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .fade-in-up { animation: fade-in-up 0.8s ease-out forwards; }

        @keyframes pop-in {
            0% { transform: scale(0.5); opacity: 0; }
            80% { transform: scale(1.05); opacity: 1; }
            100% { transform: scale(1); }
        }
        .pop-in { animation: pop-in 0.4s cubic-bezier(0.68, -0.55, 0.27, 1.55) forwards; } 
        
        /* Animation de tremblement pour mauvaise r√©ponse */
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
            20%, 40%, 60%, 80% { transform: translateX(5px); }
        }
        .shake-input { animation: shake 0.5s; border-color: #ff416c !important; }

        /* Style pour la conversation type Discord */
        .discord-message {
            max-width: 90%;
            border-radius: 12px;
            padding: 10px 15px;
            margin-bottom: 12px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
            opacity: 0;
            transform: translateX(-20px);
            animation: slide-in 0.3s ease-out forwards;
        }
        @keyframes slide-in {
            to { opacity: 1; transform: translateX(0); }
        }
        .discord-hugo {
            background-color: #5865f2; /* Bleu */
            align-self: flex-start;
        }
        .discord-other {
            background-color: #ff416c; /* Rose */
            align-self: flex-start;
        }
        
        .code-progress-box {
            background-color: #333;
            border: 2px solid #555;
            transition: all 0.3s;
        }
        .code-progress-box.unlocked {
            background-color: #48bb78; /* Vert r√©ussi */
            border-color: #68d391;
            transform: scale(1.1);
            animation: bounce 0.5s ease-out;
            box-shadow: 0 0 15px #48bb78;
        }
        @keyframes bounce {
            0%, 100% { transform: scale(1.1); }
            50% { transform: scale(1.2); }
        }
        
        /* Effet de lueur sur le titre principal */
        .glow-title {
            text-shadow: 0 0 10px #ffc107, 0 0 20px #ff416c;
        }

        /* NOUVEAU: EFFET DE DISJONCTION √âMOTIONNELLE */
        .disjunction-effect {
            background-color: #7f1d1d !important; /* Rouge fonc√© */
            animation: flicker 0.1s infinite alternate;
            border: 5px dashed #f87171;
            transition: all 0.05s linear;
        }
        @keyframes flicker {
            0% { opacity: 1; }
            50% { opacity: 0.8; }
            100% { opacity: 1; }
        }
    </style>
</head>
<body class="text-white min-h-screen flex items-center justify-center p-4">

    <!-- 1. Arri√®re-plan anim√© -->
    <div class="animated-background"></div>

    <!-- Conteneur des confettis (canvas cr√©√© en JS) -->
    <div class="confetti-container fixed top-0 left-0 w-full h-full pointer-events-none z-50" id="confetti-container"></div>

    <!-- Contenu principal centr√© -->
    <main id="mainContainer" class="w-full max-w-lg mx-auto z-10">

        <!-- Section d'Accueil (1) -->
        <section id="homeSection" class="card p-8 sm:p-12 rounded-2xl text-center shadow-2xl">
            <h1 class="text-4xl sm:text-5xl font-extrabold mb-4 text-transparent bg-clip-text bg-gradient-to-r from-yellow-400 to-pink-500 glow-title">
                Joyeux Anniversaire Papa üéâ
            </h1>
            <p class="text-lg mb-2 text-red-400 font-semibold">
                ‚ö†Ô∏è Clictez sur "Commencer" pour initialiser l'audio et les animations.
            </p>
            <p class="text-xl sm:text-2xl mb-8 text-gray-300">
                Une chasse au tr√©sor pleine d'amour et de surprises t'attend.
            </p>
            <button id="startButton" onclick="startGame()" class="btn-primary text-xl font-bold px-8 py-4 rounded-full w-full sm:w-auto">
                Commencer la chasse au tr√©sor üéØ
            </button>
        </section>

        <!-- Section des √ânigmes (2) -->
        <section id="enigmaSection" class="card p-6 sm:p-10 rounded-2xl shadow-2xl hidden">
            <h2 class="text-3xl font-bold mb-6 text-yellow-300" id="enigmaTitle"></h2>
            
            <div id="enigmaContent">
                <!-- Le contenu de l'√©nigme sera g√©n√©r√© ici par JS -->
            </div>

            <div class="mt-8 pt-4 border-t border-gray-700">
                <p class="text-lg font-semibold mb-2">Progression du Code Secret :</p>
                <div id="codeProgress" class="flex justify-center space-x-4">
                    <span id="codeLetter0" class="code-progress-box text-4xl font-black p-3 w-12 text-center rounded-lg">?</span>
                    <span id="codeLetter1" class="code-progress-box text-4xl font-black p-3 w-12 text-center rounded-lg">?</span>
                    <span id="codeLetter2" class="code-progress-box text-4xl font-black p-3 w-12 text-center rounded-lg">?</span>
                </div>
            </div>
        </section>

        <!-- Section Code Final (3) -->
        <section id="finalCodeSection" class="card p-6 sm:p-10 rounded-2xl shadow-2xl hidden text-center">
            <h2 class="text-3xl font-bold mb-6 text-green-400">Code Secret D√©bloqu√© ! üîì</h2>
            <p class="text-lg mb-4">Entre le code complet trouv√© (l'ordre est C N H) :</p>
            <input type="text" id="finalCodeInput" maxlength="3" class="w-full max-w-xs p-4 text-center text-3xl font-mono uppercase bg-gray-800 text-white rounded-xl tracking-widest focus:outline-none focus:ring-4 focus:ring-green-500 transition duration-300" placeholder="C N H" oninput="this.value = this.value.toUpperCase()">
            <button onclick="checkFinalCode()" class="btn-primary text-lg font-bold px-6 py-3 rounded-full mt-6 w-full max-w-xs">
                D√©bloquer la Surprise üéÅ
            </button>
            <p id="finalCodeMessage" class="mt-4 text-red-400 hidden">Code incorrect. R√©essaie !</p>
        </section>

        <!-- Section Contenu D√©bloqu√© (4, 5, 6) -->
        <section id="unlockedContentSection" class="card p-4 sm:p-6 rounded-2xl shadow-2xl hidden">
            <h2 class="text-3xl font-bold mb-6 text-pink-400 text-center glow-title">Le Tr√©sor de Notre Amour üíñ</h2>

            <!-- 4. Espace Messages style Discord -->
            <div id="discordChatContainer" class="bg-gray-800/80 p-4 rounded-xl mb-8 max-h-80 overflow-y-auto flex flex-col space-y-3">
                <div class="flex items-center space-x-2 mb-2 text-sm text-gray-400 sticky top-0 bg-gray-800/80 p-1 rounded-t-xl">
                    <div class="h-2 w-2 bg-pink-500 rounded-full shadow-lg shadow-pink-500/50"></div>
                    <span>Chat : Hugo & Ton Avenir (et les infiltr√©s...)</span>
                </div>
                <!-- Messages apparaissent ici -->
            </div>

            <!-- 5. D√©mo 3D (C≈ìur) -->
            <div class="mb-8">
                <h3 class="text-2xl font-semibold mb-4 text-center">Notre C≈ìur 3D qui Bat pour Toi</h3>
                <div id="threeDCanvasContainer" class="w-full h-64 sm:h-80 rounded-xl overflow-hidden shadow-xl">
                    <canvas id="threeDCanvas" class="w-full h-full"></canvas>
                </div>
                <p class="text-center text-sm text-gray-400 mt-2">
                    Manipule-le √† la souris ou au doigt. Il pulse !
                </p>
            </div>

            <!-- 6. Message Final et Code Cach√© -->
            <div id="finalMessageContainer" class="text-center mt-8 p-6 bg-red-900/40 rounded-xl border border-red-700/50 shadow-xl">
                <h3 class="text-3xl font-extrabold mb-4 text-yellow-300 pop-in glow-title">LE MESSAGE D'OR</h3>
                <p class="text-lg mb-6 leading-relaxed">
                    **P**apa, **T**u as **R**√©ussi **L**a **G**rande chasse ! Ton courage et ta perspicacit√© sont in√©gal√©s.
                    Je t'aime plus que tout, tu es la meilleure personne que je connaisse.
                    <br><br>
                    Mais attention... Regarde bien ce message ! J'ai cach√© un **ULTIME** code dans les lettres majuscules...
                    Il te donnera le dernier indice pour le cadeau physique !
                </p>

                <button onclick="showFinalClueInput()" class="btn-primary text-lg font-bold px-6 py-3 rounded-full mt-4 bg-red-600 hover:bg-red-700">
                    J'ai trouv√© le code final ! ü§î
                </button>
            </div>

            <div id="finalClueInputContainer" class="hidden mt-6 text-center">
                <p class="mb-4 text-lg">Quel est ce code de **cinq** lettres ?</p>
                <input type="text" id="hiddenCodeInput" maxlength="5" class="w-full max-w-xs p-3 text-center text-2xl font-mono uppercase bg-gray-800 text-white rounded-xl tracking-widest focus:outline-none focus:ring-4 focus:ring-red-500 transition duration-300" placeholder="P T R L G" oninput="this.value = this.value.toUpperCase()">
                <button onclick="checkHiddenCode()" class="btn-primary text-md font-bold px-4 py-2 rounded-full mt-4 w-full max-w-xs">
                    D√©voiler l'indice
                </button>
                <p id="hiddenCodeMessage" class="mt-4 text-red-400 hidden">Mauvais code... Relis attentivement !</p>
            </div>
            
            <div id="realGiftClue" class="hidden mt-8 p-8 bg-green-900/40 rounded-2xl border-4 border-green-400 shadow-lg text-center pop-in">
                <h3 class="text-4xl font-extrabold mb-4 text-green-300 glow-title">INDICE FINAL D√âBLOQU√â !</h3>
                <p class="text-2xl font-semibold text-white">
                    Ton cadeau se trouve... <br class="sm:hidden">
                    <span class="text-yellow-400 text-4xl mt-3 block">dans mon armoire üòâ</span>
                </p>
            </div>

        </section>

    </main>

    <script>
        // --- 1. SETUP GLOBAL ET CONFIGURATION ---
        
        let ELEMENTS; 
        
        // Initialisation globale des sons (sera appel√© au premier clic de l'utilisateur)
        let synth, successSound, popSound, glitchSound;

        function initializeAudio() {
            try {
                // Initialisation de Tone.js (n√©cessite un contexte audio, souvent li√© √† un clic utilisateur)
                if (Tone.context.state !== 'running') {
                    Tone.start();
                }

                synth = new Tone.PolySynth(Tone.Synth, {
                    oscillator: { type: "triangle" },
                    envelope: { release: 0.1 }
                }).toDestination();
                
                successSound = new Tone.MembraneSynth({
                    envelope: { attack: 0.01, sustain: 0.1, release: 0.2 },
                    pitchDecay: 0.05
                }).toDestination();

                popSound = new Tone.MembraneSynth({
                    pitchDecay: 0.01,
                    octaves: 6,
                    envelope: { attack: 0.001, decay: 0.4, sustain: 0.01, release: 0.1, level: 0.5 }
                }).toDestination();
                
                // NOUVEAU: Son de glitch pour la disjonction
                glitchSound = new Tone.NoiseSynth({
                    noise: { type: "pink" },
                    envelope: { attack: 0.001, decay: 0.05, sustain: 0.01, release: 0.05 }
                }).toDestination();


            } catch (error) {
                console.error("Erreur lors de l'initialisation audio:", error);
                // Fournir des fonctions vides si l'initialisation √©choue
                synth = { triggerAttackRelease: () => {} };
                successSound = { triggerAttackRelease: () => {} };
                popSound = { triggerAttackRelease: () => {} };
                glitchSound = { triggerAttackRelease: () => {} }; // Ajout du fallback
            }
        }

        // Fonctions utilitaires de son
        const clickSound = () => synth?.triggerAttackRelease("C5", "8n");
        const playSuccess = () => {
            successSound?.triggerAttackRelease("C3", "8n");
            successSound?.triggerAttackRelease("G3", "8n", "+0.05");
            successSound?.triggerAttackRelease("C4", "8n", "+0.1");
        }
        const playPop = () => popSound?.triggerAttackRelease("C2", "8n");
        // NOUVEAU: Son de glitch
        const playGlitch = () => glitchSound?.triggerAttackRelease("16n", 0.1);

        
        const ENIGMA_STAGES = [
            {
                stageTitle: "√âtape 1/3 : Ta Boisson Pr√©f√©r√©e ü•§",
                codeLetter: "C",
                question: "Quelle est ta boisson gazeuse pr√©f√©r√©e pour te rafra√Æchir ?",
                answer: "COCACOLA" 
            },
            {
                stageTitle: "√âtape 2/3 : Ta Couleur üñ§",
                codeLetter: "N",
                question: "Quelle est ta couleur pr√©f√©r√©e dans l'habillement et le design ?",
                answer: "NOIR" 
            },
            {
                stageTitle: "√âtape 3/3 : La Personne la Plus Importante üòâ",
                codeLetter: "H",
                question: "Qui suis-je ?",
                answer: "HUGO" 
            }
        ];

        const FINAL_CODE = "CNH";
        const HIDDEN_CODE = "PTRLG"; 

        let currentStageIndex = 0;
        let codeLettersFound = ["?", "?", "?"];

        // --- 2. LOGIQUE DE JEU (STAGES) ---

        function startGame() {
            // Initialisation des r√©f√©rences DOM
            ELEMENTS = {
                home: document.getElementById('homeSection'),
                enigma: document.getElementById('enigmaSection'),
                finalCode: document.getElementById('finalCodeSection'),
                unlockedContent: document.getElementById('unlockedContentSection'),
                enigmaTitle: document.getElementById('enigmaTitle'),
                enigmaContent: document.getElementById('enigmaContent'),
                finalCodeInput: document.getElementById('finalCodeInput'),
                finalCodeMessage: document.getElementById('finalCodeMessage'),
                discordChatContainer: document.getElementById('discordChatContainer'),
                threeDCanvasContainer: document.getElementById('threeDCanvasContainer'),
                finalMessageContainer: document.getElementById('finalMessageContainer'),
                hiddenCodeInput: document.getElementById('hiddenCodeInput'),
                finalClueInputContainer: document.getElementById('finalClueInputContainer'),
                hiddenCodeMessage: document.getElementById('hiddenCodeMessage'),
                realGiftClue: document.getElementById('realGiftClue'),
                confettiContainer: document.getElementById('confetti-container'),
                mainContainer: document.getElementById('mainContainer'), 
            };

            initializeAudio(); 
            clickSound();
            
            ELEMENTS.home.classList.add('hidden');
            ELEMENTS.enigma.classList.remove('hidden');
            ELEMENTS.enigma.classList.add('pop-in');
            renderEnigma();
        }

        function renderEnigma() {
            if (currentStageIndex >= ENIGMA_STAGES.length) {
                ELEMENTS.enigma.classList.add('hidden');
                ELEMENTS.finalCode.classList.remove('hidden');
                ELEMENTS.finalCode.classList.add('pop-in');
                return;
            }

            const stage = ENIGMA_STAGES[currentStageIndex];
            
            ELEMENTS.enigmaTitle.textContent = `${stage.stageTitle}`;
            
            ELEMENTS.enigmaContent.innerHTML = `
                <p class="text-xl sm:text-2xl font-semibold mb-6 text-gray-200">${stage.question}</p>
                <input type="text" id="enigmaInput" class="w-full p-4 text-center text-xl bg-gray-800 text-white rounded-xl focus:outline-none focus:ring-4 focus:ring-yellow-500 transition duration-300" placeholder="Tape ta r√©ponse ici">
                <button onclick="checkEnigmaAnswer()" class="btn-primary text-lg font-bold px-6 py-3 rounded-full mt-6 w-full">
                    Valider la R√©ponse
                </button>
                <p id="enigmaMessage" class="mt-4 text-red-400 hidden">R√©ponse incorrecte. Essaie encore !</p>
            `;
        }

        function checkEnigmaAnswer() {
            clickSound();
            const inputElement = document.getElementById('enigmaInput');
            const messageElement = document.getElementById('enigmaMessage');
            
            // Fonction pour nettoyer la r√©ponse (supprime les accents, les espaces et met en majuscules)
            const cleanAnswer = (str) => str.normalize("NFD").replace(/[\u0300-\u036f]/g, "").trim().toUpperCase().replace(/[^A-Z]/g, '');
            
            const userAnswer = cleanAnswer(inputElement.value); 
            const stage = ENIGMA_STAGES[currentStageIndex];
            const expectedAnswer = cleanAnswer(stage.answer);

            inputElement.classList.remove('shake-input');

            if (userAnswer === expectedAnswer) {
                playSuccess();
                launchConfetti(2);
                messageElement.classList.remove('text-red-400', 'hidden');
                messageElement.classList.add('text-green-400');
                
                const letterIndex = currentStageIndex;
                codeLettersFound[letterIndex] = stage.codeLetter;
                const codeBox = document.getElementById(`codeLetter${letterIndex}`);
                codeBox.textContent = stage.codeLetter;
                codeBox.classList.add('unlocked');
                
                messageElement.textContent = `Bravo ! Tu as trouv√© la lettre "${stage.codeLetter}" du code secret !`;

                currentStageIndex++; 
                
                setTimeout(() => {
                    messageElement.classList.add('hidden');
                    renderEnigma(); 
                }, 2500);

            } else {
                inputElement.classList.add('shake-input');
                messageElement.classList.remove('hidden');
                messageElement.classList.add('text-red-400');
                messageElement.textContent = "R√©ponse incorrecte. Essaie encore !";
                inputElement.value = '';
            }
        }

        function checkFinalCode() {
            clickSound();
            const input = ELEMENTS.finalCodeInput;
            const message = ELEMENTS.finalCodeMessage;

            if (input.value === FINAL_CODE) {
                playSuccess();
                launchConfetti(4); 
                message.classList.add('hidden');
                
                ELEMENTS.finalCode.classList.add('hidden');
                ELEMENTS.unlockedContent.classList.remove('hidden');
                ELEMENTS.unlockedContent.classList.add('pop-in');
                
                try {
                    initThreeD();
                    startDiscordChat();
                } catch (e) {
                    console.error("Erreur au chargement de la 3D/Chat:", e);
                }
            } else {
                input.classList.add('shake-input'); 
                message.classList.remove('hidden');
                message.textContent = "Code incorrect. Le code complet est C N H !";
                setTimeout(() => input.classList.remove('shake-input'), 500);
            }
        }
        
        // --- 3. CHAT DISCORD SIMUL√â ---

        const chatMessages = [
            { author: "Hugo", avatar: "üòé", time: "18:42", text: "Papa, bienvenue dans cette zone sp√©ciale ! J'ai voulu que cet anniversaire soit un voyage, un voyage pour te montrer que peu importe o√π tu vas, notre amour te suit, il est ta plus grande force. Prends le temps de lire ce que j'ai sur le c≈ìur. ‚ù§Ô∏è", type: "hugo", delay: 500 },
            { author: "Ton Avenir", avatar: "üåü", time: "18:43", text: "Je suis le reflet de tout ce que tu nous as donn√©. Sais-tu √† quel point ton rire contagieux, ta force tranquille, et ta patience inconditionnelle ont fa√ßonn√© mon monde ? C'est inestimable. Tu es notre ancre, notre h√©ros absolu.", type: "other", delay: 5000 },
            { author: "Hugo", avatar: "üòé", time: "18:45", text: "Je me souviens de tous les moments simples, des discussions interminables sur la vie, et des conseils que tu me donnes encore aujourd'hui. Ces souvenirs sont mon tr√©sor le plus pr√©cieux. Chaque jour √† tes c√¥t√©s est une v√©ritable b√©n√©diction. Je t'aime tellement.", type: "hugo", delay: 11000 },
            { author: "Ton Avenir", avatar: "üåü", time: "18:46", text: "Et c'est cette magie, cette √¢me g√©n√©reuse, que nous c√©l√©brons. Nous voyons en toi l'exemple de la pers√©v√©rance, de l'honn√™tet√©, et surtout, d'un amour sans faille. Joyeux anniversaire.", type: "other", delay: 18000 },
            { author: "Hugo", avatar: "üòé", time: "18:48", text: "Maintenant, regarde en bas. Notre c≈ìur 3D bat juste pour toi. Fais-le tourner, ressens notre amour, et pr√©pare-toi pour le message final...", type: "hugo", delay: 24000 },
            { author: "Agent Alpha", avatar: "üïµÔ∏è", time: "18:50", text: "Confirmation : Cibles √©motionnelles atteintes. Le sujet est √† l'√©tape 'Message d'Or'. Agent B√™ta, quel est l'√©tat du code de d√©verrouillage final ? R√©p√©tez-le, tr√®s calmement, en code morse si possible.", type: "other", delay: 30000 },
            { author: "Agent B√™ta", avatar: "ü§ñ", time: "18:51", text: "Morse ? Non ! C'est l'acronyme pour 'Papa Tr√®s Rarement Laisse Gagner'. Attendez, c'est **P.T.R.L.G.** ! Oui, √ßa y est !", type: "hugo", delay: 34000 },
            { author: "Agent Alpha", avatar: "üïµÔ∏è", time: "18:51", text: "B√äTA ! VOUS √äTES SUR LE CANAL PUBLIC ! Vous venez de hurler le mot de passe final ! Concentrez-vous sur l'indice pour le cadeau physique !", type: "other", delay: 38000 },
            { author: "Agent B√™ta", avatar: "ü§ñ", time: "18:52", text: "Mon erreur ! Le sujet est concentr√© sur le **MESSAGE D'OR**. L'indice physique... c'est l√† o√π il cache les... Ah, trouv√© ! L'indice est 'l'armoire', en haut !", type: "hugo", delay: 40500 },
            { author: "Agent Alpha", avatar: "üïµÔ∏è", time: "18:52", text: "B√äTA ! Ce n'est pas le moment de donner l'indice ! Laissez-le trouver le code cach√© lui-m√™me ! Allez, d√©gagez le canal ! *CRRRSSSSHHH*", type: "other", delay: 43000 },
            { author: "Hugo", avatar: "üòé", time: "18:53", text: "Papa, d√©sol√© pour ces interf√©rences. Ces 'Agents' sont un peu trop bavards. Concentre-toi sur le **MESSAGE D'OR** en bas pour l'ULTIME code. C'est la toute derni√®re √©tape (tu connais d√©j√† le code, on dirait) !", type: "hugo", delay: 46000 }
        ];

        function startDiscordChat() {
            chatMessages.forEach((msg) => {
                setTimeout(() => {
                    addChatMessage(msg.author, msg.avatar, msg.time, msg.text, msg.type);
                }, msg.delay);
            });
        }

        function addChatMessage(author, avatar, time, text, type) {
            playPop();
            const messageDiv = document.createElement('div');
            messageDiv.className = `discord-message flex items-start space-x-3 ${type === 'hugo' ? 'discord-hugo' : 'discord-other'} fade-in-up`;
            messageDiv.style.animationDelay = '0s';
            messageDiv.innerHTML = `
                <span class="discord-avatar text-2xl">${avatar}</span>
                <div class="flex flex-col flex-grow">
                    <div class="flex items-center space-x-2 text-xs font-medium mb-1">
                        <span class="text-white font-bold">${author}</span>
                        <span class="text-gray-300 text-opacity-75">${time}</span>
                    </div>
                    <p class="text-white text-sm">${text}</p>
                </div>
            `;
            ELEMENTS.discordChatContainer.appendChild(messageDiv);
            ELEMENTS.discordChatContainer.scrollTop = ELEMENTS.discordChatContainer.scrollHeight;
        }


        // --- 4. THREE.JS 3D COEUR ---

        let heart, pointLight, particles;
        let clock = new THREE.Clock();
        let renderer, scene, camera, canvas;

        function initThreeD() {
            try {
                const container = ELEMENTS.threeDCanvasContainer;
                canvas = document.getElementById('threeDCanvas');
                const width = container.clientWidth;
                const height = container.clientHeight;

                scene = new THREE.Scene();
                camera = new THREE.PerspectiveCamera(75, width / height, 0.1, 1000);
                renderer = new THREE.WebGLRenderer({ canvas: canvas, antialias: true, alpha: true });
                renderer.setSize(width, height);
                renderer.setPixelRatio(window.devicePixelRatio);
                camera.position.z = 4;

                scene.add(new THREE.AmbientLight(0x404040, 2)); 
                pointLight = new THREE.PointLight(0xff416c, 50, 10);
                pointLight.position.set(0, 0, 1);
                scene.add(pointLight);
                
                // Cr√©ation des particules
                const particlesGeometry = new THREE.BufferGeometry();
                const particlesCount = 500;
                const positions = new Float32Array(particlesCount * 3);

                for (let i = 0; i < particlesCount * 3; i++) {
                    positions[i] = (Math.random() - 0.5) * 20; 
                }

                particlesGeometry.setAttribute('position', new THREE.BufferAttribute(positions, 3));

                const particlesMaterial = new THREE.PointsMaterial({
                    color: 0xeeeeff, size: 0.05, sizeAttenuation: true, transparent: true, opacity: 0.8
                });

                particles = new THREE.Points(particlesGeometry, particlesMaterial);
                scene.add(particles);

                // Cr√©ation du coeur 3D
                const scale = 1.5;
                const heartShape = new THREE.Shape();
                heartShape.moveTo( 0, -0.4 * scale );
                heartShape.bezierCurveTo( -0.7 * scale, 0.6 * scale, -1.5 * scale, 0.4 * scale, 0, 1.2 * scale );
                heartShape.bezierCurveTo( 1.5 * scale, 0.4 * scale, 0.7 * scale, 0.6 * scale, 0, -0.4 * scale );

                const extrudeSettings = {
                    steps: 2, depth: 0.5 * scale, bevelEnabled: true, bevelThickness: 0.1,
                    bevelSize: 0.1, bevelOffset: 0, bevelSegments: 10
                };

                const heartGeometry = new THREE.ExtrudeGeometry(heartShape, extrudeSettings);
                
                const heartMaterial = new THREE.MeshPhongMaterial({
                    color: 0xff416c, specular: 0xffffff, shininess: 150, emissive: 0xaa1133, emissiveIntensity: 0.5
                });

                heart = new THREE.Mesh(heartGeometry, heartMaterial);
                
                heart.position.set(0, 0, 0);
                heart.rotation.x = -Math.PI * 0.5;
                heart.rotation.z = Math.PI;

                scene.add(heart);

                // Contr√¥le de la souris et du toucher pour la rotation
                let isDragging = false;
                let previousMousePosition = { x: 0, y: 0 };
                
                function onMouseDown(event) {
                    isDragging = true;
                    previousMousePosition.x = event.clientX || event.touches[0].clientX;
                    previousMousePosition.y = event.clientY || event.touches[0].clientY;
                }

                function onMouseUp() {
                    isDragging = false;
                }

                function onMouseMove(event) {
                    if (!isDragging) return;
                    
                    const clientX = event.clientX || event.touches[0].clientX;
                    const clientY = event.clientY || event.touches[0].clientY;

                    const deltaX = clientX - previousMousePosition.x;
                    const deltaY = clientY - previousMousePosition.y;

                    heart.rotation.y += deltaX * 0.01;
                    heart.rotation.x += deltaY * 0.005;

                    previousMousePosition.x = clientX;
                    previousMousePosition.y = clientY;
                }

                canvas.addEventListener('mousedown', onMouseDown, false);
                window.addEventListener('mouseup', onMouseUp, false);
                canvas.addEventListener('mousemove', onMouseMove, false);
                canvas.addEventListener('touchstart', onMouseDown, false);
                window.addEventListener('touchend', onMouseUp, false);
                canvas.addEventListener('touchmove', (e) => {
                    e.preventDefault(); 
                    onMouseMove(e);
                }, { passive: false });


                function animate() {
                    requestAnimationFrame(animate);

                    const elapsedTime = clock.getElapsedTime();
                    
                    // Rotation automatique et pulsations
                    if (!isDragging) {
                        heart.rotation.y += 0.005;
                        heart.rotation.x = Math.sin(elapsedTime * 0.5) * 0.1 - Math.PI * 0.5;
                    }
                    
                    const pulseScale = 1 + Math.sin(elapsedTime * 5) * 0.05;
                    pointLight.intensity = 50 * pulseScale;
                    heart.scale.set(pulseScale, pulseScale, pulseScale);
                    
                    particles.rotation.y += 0.0005;

                    renderer.render(scene, camera);
                }

                // Gestion du redimensionnement
                window.addEventListener('resize', onWindowResize, false);
                function onWindowResize() {
                    const newWidth = container.clientWidth;
                    const newHeight = container.clientHeight;
                    camera.aspect = newWidth / newHeight;
                    camera.updateProjectionMatrix();
                    renderer.setSize(newWidth, newHeight);
                }
                onWindowResize();

                animate();
            } catch (error) {
                console.error("Erreur lors de l'initialisation Three.js (v√©rifie si le GPU est support√©):", error);
            }
        }

        // --- 5. LOGIQUE DU CODE CACH√â FINAL SIMPLIFI√âE ---

        function showFinalClueInput() {
            clickSound();
            ELEMENTS.finalClueInputContainer.classList.toggle('hidden');
            ELEMENTS.hiddenCodeInput.focus();
        }

        function checkHiddenCode() {
            clickSound();
            const input = ELEMENTS.hiddenCodeInput;
            const message = ELEMENTS.hiddenCodeMessage;

            if (input.value === HIDDEN_CODE) {
                // D√©clenche l'effet de disjonction au lieu de r√©v√©ler directement
                triggerEmotionalDisjunction();
            } else {
                input.classList.add('shake-input');
                message.classList.remove('hidden');
                message.textContent = "Mauvais code... Relis attentivement le message en majuscules (P T R L G) !";
                setTimeout(() => input.classList.remove('shake-input'), 500);
            }
        }
        
        // --- 6. EFFET DE DISJONCTION √âMOTIONNELLE (NOUVELLE FONCTION) ---

        function triggerEmotionalDisjunction() {
            const body = document.body;
            
            // 1. D√©marrer l'effet visuel et sonore
            // L'effet CSS est g√©r√© par la classe 'disjunction-effect' sur <body>
            body.classList.add('disjunction-effect');
            playGlitch();

            // 2. Simuler plusieurs "bugs" courts via le filtre CSS (glitch d'image)
            const glitchDuration = 500; // 0.5s total
            const interval = 50; // intervalle entre les flashes

            for (let i = 0; i < glitchDuration / interval; i++) {
                // Flash visuel
                setTimeout(() => {
                    body.style.filter = 'saturate(5) hue-rotate(90deg)'; // Forte saturation + changement de teinte
                    playGlitch(); // Rejouer le son
                }, interval * i);
                
                // Nettoyage rapide de l'effet
                setTimeout(() => {
                    body.style.filter = 'none';
                }, interval * i + (interval / 2));
            }
            
            // 3. Apr√®s l'effet court, nettoyer et r√©v√©ler le cadeau
            setTimeout(() => {
                body.classList.remove('disjunction-effect');
                body.style.filter = 'none';
                
                playSuccess(); // Son de succ√®s apr√®s le bug
                launchConfetti(4); 

                ELEMENTS.hiddenCodeMessage.classList.add('hidden');
                ELEMENTS.finalClueInputContainer.classList.add('hidden');
                ELEMENTS.finalMessageContainer.classList.add('hidden');

                ELEMENTS.realGiftClue.classList.remove('hidden');
                ELEMENTS.realGiftClue.classList.add('pop-in');
            }, glitchDuration + 50); // Attendre que le dernier flash soit termin√©.
        }


        // --- 7. EFFETS VISUELS (CONFETTI) ---

        function launchConfetti(count = 2) {
            const colors = ['#ff416c', '#ff4b2b', '#ffd700', '#5865f2', '#38a169', '#ffffff'];
            const container = ELEMENTS.confettiContainer;
            let canvas = container.querySelector('canvas');
            
            if (!canvas) {
                canvas = document.createElement('canvas');
                container.appendChild(canvas);
            }

            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            const ctx = canvas.getContext('2d');
            const particles = [];
            const W = canvas.width;
            const H = canvas.height;

            class Particle {
                constructor(x, y) {
                    this.x = x || W / 2;
                    this.y = y || H / 2;
                    this.color = colors[Math.floor(Math.random() * colors.length)];
                    this.tilt = Math.floor(Math.random() * 10) - 10;
                    this.tiltAngleIncremental = (Math.random() * 0.07) + 0.05;
                    this.tiltAngle = 0;
                    this.size = (Math.random() * 9) + 5;
                    this.speed = (Math.random() * 8) + 5; 
                    this.angle = Math.random() * Math.PI * 2;
                    this.velocity = {
                        x: Math.cos(this.angle) * this.speed,
                        y: Math.sin(this.angle) * this.speed - 10,
                    };
                    this.gravity = 0.3;
                    this.drag = 0.95;
                }

                update() {
                    this.velocity.x *= this.drag;
                    this.velocity.y += this.gravity;
                    this.x += this.velocity.x;
                    this.y += this.velocity.y;
                    this.tiltAngle += this.tiltAngleIncremental;
                    this.tilt = Math.sin(this.tiltAngle) * 10;
                    return this.y > H;
                }

                draw() {
                    ctx.beginPath();
                    ctx.lineWidth = this.size;
                    ctx.strokeStyle = this.color;
                    ctx.save();
                    ctx.translate(this.x, this.y);
                    ctx.rotate(this.tiltAngle);
                    ctx.lineTo(0, this.tilt);
                    ctx.stroke();
                    ctx.restore();
                }
            }

            for (let i = 0; i < 50 * count; i++) {
                particles.push(new Particle(W / 2, H / 2)); 
            }

            let animationFrameId;
            const render = () => {
                ctx.clearRect(0, 0, W, H);
                
                for (let i = particles.length - 1; i >= 0; i--) {
                    particles[i].update();
                    particles[i].draw();
                    if (particles[i].y > H + 50) {
                        particles.splice(i, 1);
                    }
                }

                if (particles.length > 0) {
                    animationFrameId = requestAnimationFrame(render);
                } else {
                    cancelAnimationFrame(animationFrameId);
                    if (container.contains(canvas)) {
                        // Nettoyage apr√®s l'animation
                        setTimeout(() => container.removeChild(canvas), 100);
                    }
                }
            }
            render();

            function onConfettiResize() {
                if (canvas) {
                    canvas.width = window.innerWidth;
                    canvas.height = window.innerHeight;
                }
            }
            window.removeEventListener('resize', onConfettiResize);
            window.addEventListener('resize', onConfettiResize);
        }
    </script>
</body>
</html>
